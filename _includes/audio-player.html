{% comment %}
Simplified HTML5-native audio player with minimal JavaScript
Uses native HTML5 audio features where possible
{% endcomment %}

{% assign audio_id = include.audio_url | split: '/' | last | split: '.' | first | append: '-player' %}

<div class="w-full audio-player" data-audio-url="{{ include.audio_url }}" data-episode-id="{{ include.episode_id | default: 'unknown' }}">
  <!-- Native HTML5 Audio Element -->
  <audio
    id="{{ audio_id }}"
    preload="metadata"
    src="{{ include.audio_url }}"
    class="sr-only">
    <source src="{{ include.audio_url }}" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- Player Interface -->
  <div class="relative p-6 w-full h-full bg-white rounded-2xl player-controls shadow-[0px_0px_0px_1px_rgba(9,9,11,0.07),0px_2px_2px_0px_rgba(9,9,11,0.05)] dark:bg-stone-900 dark:shadow-[0px_0px_0px_1px_rgba(255,255,255,0.1)] dark:before:pointer-events-none dark:before:absolute dark:before:-inset-px dark:before:rounded-2xl dark:before:shadow-[0px_2px_8px_0px_rgba(0,0,0,0.20),0px_1px_0px_0px_rgba(255,255,255,0.06)_inset]">
    <!-- Track Title -->
    {% if include.title %}
    <div class="mb-4">
      <h3 class="text-lg font-semibold dark:text-white text-stone-900">{{ include.title }}</h3>
    </div>
    {% endif %}

    <div class="flex gap-6 items-center">

      <!-- Large Play Button -->
      <button type="button"
              class="flex flex-shrink-0 justify-center items-center rounded-full transition-colors duration-200 cursor-pointer dark:bg-white play-pause-btn bg-stone-900 size-14 dark:hover:bg-stone-100 hover:bg-stone-800"
              aria-label="Play sermon"
              onclick="togglePlay(this)">
        <!-- Play Icon -->
        {% include icon.html name="play" type="solid" size="24" class="ml-0.5 text-white play-icon size-6 dark:text-stone-900" %}
        <!-- Pause Icon -->
        {% include icon.html name="pause" type="solid" size="24" class="hidden text-white pause-icon size-6 dark:text-stone-900" %}
      </button>

      <!-- Current Time -->
      <div class="flex-shrink-0 font-mono text-base font-medium text-stone-600 current-time dark:text-stone-300">
        0:00
      </div>

      <!-- HTML5 Range Slider (Scrubber) -->
      <div class="relative flex-1">
        <!-- Background track -->
        <div class="flex absolute inset-y-0 right-0 left-0 z-0 items-center">
          <div class="w-full h-1.5 rounded-full bg-stone-200 dark:bg-stone-700">
            <div class="w-0 h-full rounded-full progress-bg bg-saints-500 [transition:width_0.35s_cubic-bezier(0.4,0.01,0.165,0.99)]"></div>
          </div>
        </div>
        <!-- Range input overlay -->
        <input
          type="range"
          class="relative z-20 w-full h-1.5 bg-transparent cursor-pointer audio-scrubber"
          min="0"
          max="100"
          value="0"
          step="0.1"
          oninput="scrubTo(this)"
          aria-label="Sermon progress - drag to seek">
      </div>

      <!-- Total Time -->
      <div class="flex-shrink-0 font-mono text-base font-medium text-stone-600 duration dark:text-stone-300">
        --:--
      </div>

      <!-- Control Buttons -->
      <div class="flex gap-3 items-center">
        <!-- Skip Backward -->
        <button type="button"
                class="flex relative gap-1.5 justify-center items-center px-4 h-10 bg-transparent rounded-lg border transition-colors duration-200 cursor-pointer border-zinc-950/10 text-stone-700 dark:border-white/10 dark:hover:border-white/20 dark:bg-white/5 dark:hover:bg-white/10 dark:text-stone-300 dark:hover:text-stone-300 hover:border-zinc-950/20 hover:bg-zinc-50 hover:text-stone-700 focus:outline-hidden"
                aria-label="Skip back 15 seconds"
                onclick="skipTime(-15, this)">
          {% include icon.html name="arrow-uturn-left" type="mini" class="flex-shrink-0 size-4" %}
          <span class="flex-shrink-0 font-mono text-sm font-medium leading-none">15</span>
        </button>

        <!-- Skip Forward -->
        <button type="button"
                class="flex relative gap-1.5 justify-center items-center px-4 h-10 bg-transparent rounded-lg border transition-colors duration-200 cursor-pointer border-zinc-950/10 text-stone-700 dark:border-white/10 dark:hover:border-white/20 dark:bg-white/5 dark:hover:bg-white/10 dark:text-stone-300 dark:hover:text-stone-300 hover:border-zinc-950/20 hover:bg-zinc-50 hover:text-stone-700 focus:outline-hidden"
                aria-label="Skip forward 15 seconds"
                onclick="skipTime(15, this)">
          <span class="flex-shrink-0 font-mono text-sm font-medium leading-none">15</span>
          {% include icon.html name="arrow-uturn-right" type="mini" class="flex-shrink-0 size-4" %}
        </button>

        <!-- Speed Control -->
        <button type="button"
                class="flex relative flex-shrink-0 justify-center items-center px-4 h-10 text-sm font-medium bg-transparent rounded-lg border transition-colors duration-200 cursor-pointer speed-btn border-zinc-950/10 text-stone-700 dark:border-white/10 dark:hover:border-white/20 dark:bg-white/5 dark:hover:bg-white/10 dark:text-stone-300 dark:hover:text-stone-300 hover:border-zinc-950/20 hover:bg-zinc-50 hover:text-stone-700 focus:outline-hidden"
                aria-label="Change playback speed"
                onclick="cycleSpeed(this)">
          <span class="speed-text">1×</span>
        </button>

        <!-- Download Button -->
        <a href="{{ include.audio_url }}"
           download
           class="flex relative justify-center items-center bg-transparent rounded-lg border transition-colors duration-200 cursor-pointer download-btn size-10 border-zinc-950/10 text-stone-700 dark:border-white/10 dark:hover:border-white/20 dark:bg-white/5 dark:hover:bg-white/10 dark:text-stone-300 dark:hover:text-stone-300 hover:border-zinc-950/20 hover:bg-zinc-50 hover:text-stone-700 focus:outline-hidden"
           aria-label="Download sermon">
          {% include icon.html name="arrow-down-tray" type="mini" class="size-4" %}
        </a>
      </div>
    </div>
  </div>
</div>


<script>
// Minimal JavaScript for custom features only
function getAudio(element) {
  return element.closest('.audio-player').querySelector('audio');
}

function formatTime(seconds) {
  if (!isFinite(seconds)) return '--:--';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function togglePlay(button) {
  const audio = getAudio(button);

  if (audio.paused) {
    const playPromise = audio.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.error('Error playing audio:', error);
        // Audio failed to play, reset button state
        const playIcon = button.querySelector('.play-icon');
        const pauseIcon = button.querySelector('.pause-icon');
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        button.setAttribute('aria-label', 'Play sermon');
      });
    }
  } else {
    audio.pause();
  }
  // State updates now handled by audio 'play' and 'pause' event listeners
}

function skipTime(seconds, button) {
  const audio = getAudio(button || event.target);
  if (audio && audio.duration) {
    audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, audio.duration));
    saveState(audio);
  }
}

function scrubTo(scrubber) {
  const audio = getAudio(scrubber);
  if (!audio.duration) return;

  const percent = scrubber.value / 100;
  audio.currentTime = percent * audio.duration;
  saveState(audio);
}

function cycleSpeed(button) {
  const audio = getAudio(button);
  const speeds = [1, 1.25, 1.5, 2];
  const currentSpeed = audio.playbackRate;
  const currentIndex = speeds.indexOf(currentSpeed);
  const nextIndex = (currentIndex + 1) % speeds.length;
  const newSpeed = speeds[nextIndex];

  audio.playbackRate = newSpeed;
  button.querySelector('.speed-text').textContent = newSpeed === 1 ? '1×' : `${newSpeed}×`;
  saveState(audio);
}

// LocalStorage functions for state persistence
function saveState(audio) {
  const player = audio.closest('.audio-player');
  const playerId = getPlayerId(audio);
  const speedBtn = player.querySelector('.speed-btn');
  const speeds = [1, 1.25, 1.5, 2];
  const currentSpeedIndex = speeds.indexOf(audio.playbackRate);

  const state = {
    currentTime: audio.currentTime,
    playbackRate: audio.playbackRate,
    speedIndex: currentSpeedIndex,
    lastPlayed: Date.now()
  };
  localStorage.setItem(`sermon-${playerId}`, JSON.stringify(state));
}

function loadState(audio) {
  const playerId = getPlayerId(audio);
  const saved = localStorage.getItem(`sermon-${playerId}`);
  if (saved) {
    return JSON.parse(saved);
  }
  return null;
}

function restoreState(audio) {
  const savedState = loadState(audio);
  const player = audio.closest('.audio-player');

  if (savedState) {
    // Restore playback speed
    if (savedState.playbackRate) {
      audio.playbackRate = savedState.playbackRate;
      const speedBtn = player.querySelector('.speed-btn');
      if (speedBtn) {
        const speedText = speedBtn.querySelector('.speed-text');
        const speed = savedState.playbackRate;
        speedText.textContent = speed === 1 ? '1×' : `${speed}×`;
      }
    }

    // Restore playback position (only if within 7 days and more than 5 seconds)
    if (savedState.lastPlayed && (Date.now() - savedState.lastPlayed) < 7 * 24 * 60 * 60 * 1000) {
      if (savedState.currentTime && savedState.currentTime > 5) {
        audio.currentTime = savedState.currentTime;
      }
    }
  }
}

function getPlayerId(audio) {
  const player = audio.closest('.audio-player');
  const episodeId = player.dataset.episodeId;

  // Use episode_id if available, otherwise fallback to filename
  if (episodeId && episodeId !== 'unknown') {
    return episodeId;
  }

  // Fallback to filename extraction
  const audioUrl = player.dataset.audioUrl || audio.src;
  return audioUrl.split('/').pop().split('.')[0];
}

// Set up native HTML5 event listeners
document.addEventListener('DOMContentLoaded', function() {
  const players = document.querySelectorAll('.audio-player');

  players.forEach(player => {
    const audio = player.querySelector('audio');
    const currentTime = player.querySelector('.current-time');
    const duration = player.querySelector('.duration');
    const scrubber = player.querySelector('.audio-scrubber');
    const progressBg = player.querySelector('.progress-bg');

    // Update time displays and scrubber position
    audio.addEventListener('timeupdate', function() {
      currentTime.textContent = formatTime(audio.currentTime);
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        scrubber.value = percent;
        // Update the visual progress background
        progressBg.style.width = percent + '%';
      }
    });

    // Set duration when metadata loads
    audio.addEventListener('loadedmetadata', function() {
      duration.textContent = formatTime(audio.duration);
      scrubber.max = 100;
      // Initialize progress background
      progressBg.style.width = '0%';
      // Restore saved state (position, speed, etc.)
      restoreState(audio);
    });

    // Handle loading errors
    audio.addEventListener('error', function(e) {
      console.error('Audio loading error for:', audio.src, e);
      duration.textContent = 'Unavailable';
      currentTime.textContent = '--:--';

      // Disable player controls when audio fails to load
      const playButton = player.querySelector('.play-pause-btn');
      const controlButtons = player.querySelectorAll('button, a');
      const scrubber = player.querySelector('.audio-scrubber');

      playButton.disabled = true;
      playButton.style.opacity = '0.5';
      playButton.style.cursor = 'not-allowed';
      scrubber.disabled = true;

      controlButtons.forEach(btn => {
        if (btn !== playButton) {
          btn.style.opacity = '0.5';
          btn.style.pointerEvents = 'none';
        }
      });
    });

    // Update button state when audio plays
    audio.addEventListener('play', function() {
      const button = player.querySelector('.play-pause-btn');
      const playIcon = button.querySelector('.play-icon');
      const pauseIcon = button.querySelector('.pause-icon');

      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
      button.setAttribute('aria-label', 'Pause sermon');
      saveState(audio);
    });

    // Update button state when audio pauses
    audio.addEventListener('pause', function() {
      const button = player.querySelector('.play-pause-btn');
      const playIcon = button.querySelector('.play-icon');
      const pauseIcon = button.querySelector('.pause-icon');

      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      button.setAttribute('aria-label', 'Play sermon');
      saveState(audio);
    });

    // Reset play button when audio ends
    audio.addEventListener('ended', function() {
      const button = player.querySelector('.play-pause-btn');
      const playIcon = button.querySelector('.play-icon');
      const pauseIcon = button.querySelector('.pause-icon');

      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      button.setAttribute('aria-label', 'Play sermon');
    });
  });
});
</script>

